<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ArthaKulam – Client Reach Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

#map {
    height: 100vh;
    width: 100vw;
}

.bubble-label {
    font-size: 12px;
    font-weight: bold;
    color: white;
    pointer-events: none;
    display: flex;
    justify-content: center;
    align-items: center;
}

@keyframes bubbleGrow {
    0% { transform: scale(0.2); opacity: 0.2; }
    100% { transform: scale(1); opacity: 1; }
}

/* NEW — Total Clients Box */
#totalBox {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    z-index: 9999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
</style>
</head>

<body>

<!-- NEW — Total Clients Box -->
<div id="totalBox">Total Clients: Loading...</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ------------------------------------------------------
// CONFIG
// ------------------------------------------------------
const REPO = "mukkelian/arthakulam-data";
const DATA_FOLDER = "data";

// ------------------------------------------------------
// Initialize map
// ------------------------------------------------------
const map = L.map('map', {
    minZoom: 4,
    maxZoom: 10
}).setView([23.5, 80], 5);

// OpenStreetMap (with required attribution)
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// ------------------------------------------------------
// Load India Boundary
// ------------------------------------------------------
fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
  .then(r => r.json())
  .then(world => {
      const india = world.features.find(f => f.properties.ADMIN === "India");

      L.geoJSON(india, {
          style: { color: "#333", weight: 1, fillOpacity: 0.05 }
      }).addTo(map);
  });

// ------------------------------------------------------
// Fetch ALL CSV files inside /data/ folder
// ------------------------------------------------------
async function fetchAllCSVs() {

    const apiUrl = `https://api.github.com/repos/${REPO}/contents/${DATA_FOLDER}`;
    const folderResp = await fetch(apiUrl);
    const folderFiles = await folderResp.json();

    const csvFiles = folderFiles.filter(f => f.name.endsWith(".csv"));

    let allRows = [];

    for (const file of csvFiles) {
        const rawUrl = file.download_url;
        const csvText = await fetch(rawUrl).then(r => r.text());

        const lines = csvText.trim().split("\n");
        lines.shift(); // remove header

        lines.forEach(line => {
            const [location, lat, lon] = line.split(",");
            allRows.push({
                LOCATION: location.trim(),
                LAT: parseFloat(lat),
                LON: parseFloat(lon)
            });
        });
    }

    // RENDER BUBBLES
    renderBubbles(allRows);

    // NEW — UPDATE TOTAL CLIENTS
    document.getElementById("totalBox").textContent =
        "Total Clients: " + allRows.length;
}

fetchAllCSVs();

// ------------------------------------------------------
// Render bubbles (clean version)
// ------------------------------------------------------
function renderBubbles(data) {

    const grouped = {};

    data.forEach(e => {
        const key = `${e.LAT},${e.LON}`;
        if (!grouped[key]) {
            grouped[key] = { count: 0, city: e.LOCATION, lat: e.LAT, lon: e.LON };
        }
        grouped[key].count++;
    });

    Object.values(grouped).forEach(item => {

        const radius = 8 + item.count * 0.25;

        const circle = L.circleMarker([item.lat, item.lon], {
            radius,
            fillColor: "#ff7675",
            color: "#d63031",
            weight: 1.5,
            fillOpacity: 0.85
        }).addTo(map);

        circle.bindTooltip(`<b>${item.city}</b><br>Clients: ${item.count}`);

        const label = L.divIcon({
            className: "",
            html: `
              <div class="bubble-label" style="
                width:${radius*2}px;
                height:${radius*2}px;
                border-radius:50%;
                animation:bubbleGrow 0.3s ease-out;
              ">${item.count}</div>
            `,
            iconSize: [radius*2, radius*2],
            iconAnchor: [radius, radius],
            interactive: false
        });

        L.marker([item.lat, item.lon], { icon: label, interactive: false }).addTo(map);
    });
}
</script>

</body>
</html>
