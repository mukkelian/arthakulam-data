<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ArthaKulam – Client Location Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

#map {
    height: 100vh;
    width: 100vw;
}

.bubble-label {
    font-size: 12px;
    font-weight: bold;
    color: white;
    pointer-events: none;
    display: flex;
    justify-content: center;
    align-items: center;
}

@keyframes bubbleGrow {
    0% { transform: scale(0.2); opacity: 0.2; }
    100% { transform: scale(1); opacity: 1; }
}
</style>
</head>

<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// CSV URL
const CSV_URL = "https://raw.githubusercontent.com/mukkelian/arthakulam-data/refs/heads/main/ArthaKulam_data.csv";

// Initialize map
const map = L.map('map', {
    minZoom: 4,
    maxZoom: 10
}).setView([23.5, 80], 5);

// OpenStreetMap Tiles + Attribution
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Load India boundary
fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
  .then(r => r.json())
  .then(world => {
      const india = world.features.find(f => f.properties.ADMIN === "India");

      L.geoJSON(india, {
          style: { color: "#333", weight: 1, fillOpacity: 0.05 }
      }).addTo(map);
  });

// Load CSV
fetch(CSV_URL)
  .then(r => r.text())
  .then(csv => {
      const rows = csv.trim().split("\n");
      rows.shift(); // remove header

      const data = rows.map(row => {
          const [location, lat, lon] = row.split(",");
          return {
              LOCATION: location.trim(),
              LAT: parseFloat(lat),
              LON: parseFloat(lon)
          };
      });

      renderBubbles(data);
  });

// Render bubbles
function renderBubbles(data) {

    const grouped = {};

    data.forEach(e => {
        const key = `${e.LAT},${e.LON}`;
        if (!grouped[key]) grouped[key] = { count: 0, city: e.LOCATION, lat: e.LAT, lon: e.LON };
        grouped[key].count++;
    });

    Object.values(grouped).forEach(item => {

        // Bubble radius control
        const radius = 8 + item.count * 0.5;

        // Circle bubble (this receives the click)
        const circle = L.circleMarker([item.lat, item.lon], {
            radius,
            fillColor: "#ff7675",
            color: "#d63031",
            weight: 1.5,
            fillOpacity: 0.85
        }).addTo(map);

        // Tooltip on hover
        circle.bindTooltip(`<b>${item.city}</b><br>Clients: ${item.count}`);

        // CLICK POPUP (Fixed & Working)
     //   circle.on("click", () => {
     //       L.popup()
     //         .setLatLng([item.lat, item.lon])
     //         .setContent(`<b>${item.city}</b><br>Clients: ${item.count}`)
     //         .openOn(map);
     //   });

        // Label marker (IMPORTANT: interactive: false)
        const label = L.divIcon({
            className: "",
            html: `
              <div class="bubble-label" style="
                width:${radius*2}px;
                height:${radius*2}px;
                border-radius:50%;
                animation:bubbleGrow 0.3s ease-out;
              ">${item.count}</div>
            `,
            iconSize: [radius*2, radius*2],
            iconAnchor: [radius, radius]
        });

        // This marker MUST BE NON-INTERACTIVE
        L.marker([item.lat, item.lon], { icon: label, interactive: false }).addTo(map);
    });
}
</script>

</body>
</html>
